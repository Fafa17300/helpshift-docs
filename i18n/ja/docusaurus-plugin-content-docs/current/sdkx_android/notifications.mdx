---
sidebar_position: 50
title: 通知
description: "プッシュ通知とアプリ内通知の設定について詳しく説明します。"
---

import {
  Admonition,
  CodeBlock,
  Tabs,
  TabItem,
  LatestSdkVersion,
  Centered,
  Image,
  Intro,
  SideBySide,
  DownloadButton,
  Steps,
  Step,
} from "@site/src/components/forDocs";

# 通知 {#notifications}

<Intro>

プッシュ通知を構成する

</Intro>

<Admonition type="info" title="注意">

SDK に含まれているすべてのパブリック API は、[Helpshift.install() API](/sdkx_android/getting-started#start-using)を介して SDK を初期化した後に呼び出す必要があります。

- Android 13 以降では、通知のアクセス許可はクライアントアプリによって要求されるはずです。

</Admonition>

## Helpshift を介したプッシュ通知 {#push-via-helpshift}

<Image
  src="/static/books/sdkx_android/app_notification.png"
  width="half"
  alt="urbanAirshipNotif.png"
/>{" "}

Helpshift では、エージェントが会話に返信したタイミングでプッシュ通知を送信することができます。

### 前提条件 {#gcm-prerequisites}

アプリに FCM プッシュ通知を実装します。

FCM については、
[Firebase Cloud Messaging](https://firebase.google.com/docs/cloud-messaging)のドキュメントをご参照ください。

### Helpshift エージェントダッシュボードを構成する {#configure-helpshift-push-admin}

Helpshift のシステムがユーザー
にプッシュ通知を送信できるようにするには、アプリにプラットフォームとして**Android**を追加する必要があります*（まだ追加していない場合）*。

<Image
  src="/static/books/helpshiftx/create_app_with_android_platform.png"
  width="full"
/>{" "}

「構成」ボタンをクリックし、*プッシュ通知*オプションをクリックします。

**「設定」ページ、左側のナビゲーションにある「アプリ一覧」の順に移動し、
プッシュ
通知の設定**セクションまで下にスクロールし、アプリごとに FCM キーの認証情報を入力します。

<Image src="/static/books/helpshiftx/add_fcm_token.png" width="full" />{" "}

FCM ユーザーの場合、API キーは
[Firebase API コンソール](https://console.firebase.google.com/)でご確認いただけます。

<Image src="/static/books/android/fcm_console.png" width="full" />{" "}

<br />

### SDK を構成する {#configure-sdkx-android}

1. `Helpshift.registerDeviceToken` API 経由で Helpshift にデバイス登録 ID を送信します。

```java
        public class MyFirebaseMessagingService extends FirebaseMessagingService {

        // ...
        @Override
        public void onNewToken(String newToken) {
          // your logic to save the token here for the app
          Helpshift.registerPushToken(newToken);
        }
      }
```

2. 引数"RemoteMessage"を提供する FCM の新しい`FirebaseMessagingService`を使用するには、引数 Map を取る`Helpshift.handlePush` API を使用する必要があります。

```java
        @Override
        public void onMessageReceived(RemoteMessage message) {
          Map<String, String> data = message.getData();
          String origin = data.get("origin");
          if (origin != null && origin.equals("helpshift")) {
            Helpshift.handlePush(data);
          }
        }
```

## アプリ内通知 {#in-app-notifications}

アプリ内通知は、[通知ドロワー](http://developer.android.com/guide/topics/ui/notifiers/notifications.html)内の通知に似ています。プッシュ通知とは異なり、アプリの実行中にのみ表示されます。

これらの通知は、エージェントが顧客の問題に返信したタイミングで送信されます。顧客は、通知をタップすることで直接[会話画面](/sdkx_android/support-tools#conversation-view)に移動することができます。

<Centered >

![](/static/books/sdkx_android/notification.png)

</Centered>

<Admonition type="info" title="注意">

FCM のデバイストークンがプッシュ通知に登録されている場合、アプリ内通知は無効化されます。アプリ内通知が無効化されるのは、プッシュ通知とアプリ内通知の重複を回避するためです。

</Admonition>

## 通知アイコンのカスタマイズ {#notification-icon}

デフォルトでは、アプリケーションアイコンが通知アイコンとして使用されます。通知アイコンは、`install`呼び出しの構成を使用してカスタマイズすることができます。

```java
    public class MainApplication extends Application {

      @Override
      public void onCreate() {
        super.onCreate();

        Map<String, Object> configurations = new HashMap<>();
        configurations.put("notificationIcon", R.drawable.notification_icon);
        configurations.put("notificationLargeIcon", R.drawable.notification_large_icon);

        // Install call
        Helpshift.install(this,
                          "<PLATFORM_ID>",
                          "<DOMAIN>",
                          configurations);
      }
    }
```

## 通知音のカスタマイズ {#notificationSound}

デフォルトでは、デフォルトのデバイス通知音が Helpshift の通知に使用されます。通知音は、インストール呼び出しの構成を使用してカスタマイズすることができます。

例:

```java
    public class MainApplication extends Application {

      @Override
      public void onCreate() {
        super.onCreate();

        Map<String, Object> configurations = new HashMap<>();
        configurations.put("notificationSoundId",  R.raw.notification_sound);

        // Install call
        Helpshift.install(this,
                          "<PLATFORM_ID>",
                          "<DOMAIN>",
                          configurations);
      }
    }
```

## 通知チャネルのカスタマイズ {#notificationChannels}

Android Oreo 以降、Helpshift の通知は`In-app Support`という名前のデフォルトのチャネルを作成します。デフォルトのチャネル名と説明をカスタマイズする場合は、`install`呼び出しの`config`を使用します。

例:

```java
    public class MainApplication extends Application {

      @Override
      public void onCreate() {
        super.onCreate();

        Map<String, Object> configurations = new HashMap<>();
        configurations.put("notificationChannelId",  "your channel name here");

        // Install call
        Helpshift.install(this,
                          "<PLATFORM_ID>",
                          "<DOMAIN>",
                          configurations);
      }
    }
```

## アプリ内通知を構成する {#in-app}

Helpshift SDK が提供するアプリ内通知サポートが不要な場合には、フラグを`false`に設定します。このフラグの規定値は`true`であり、この場合アプリ内通知が有効化されます。

- `Flag:` enableInAppNotification
- `Values:` true/false
- `Default:` true

例:

```java
    public class MainApplication extends Application {

      @Override
      public void onCreate() {
        super.onCreate();

        Map<String, Object> configurations = new HashMap<>();
        configurations.put("enableInAppNotification",  false);

        // Install call
        Helpshift.install(this,
                          "<PLATFORM_ID>",
                          "<DOMAIN>",
                          configurations);
      }
    }
```

## ユーザーに返信が送信された際の通知数の表示 {#showing-notification-count}

サーバーから未読メッセージの数を取得するには、`requestUnreadMessageCount(boolean shouldFetchFromServer)` API を呼び出します。この API は、未読メッセージの数をデリゲート経由で返します。
`shouldFetchFromServer`の値に基づき、`shouldFetchFromServer`が`false`の場合にはローカルに保存されている数が返され、`shouldFetchFromServer`が`true`の場合にはサーバーからリモートで取得します。

```java
    private void updateAppBadgeCount(){
        Helpshift.requestUnreadMessageCount(false);
    }

    // ...
    Helpshift.setHelpshiftEventsListener(new HelpshiftEventsListener() {
      @Override
      public void onEventOccurred(@NonNull String eventName, Map<String, Object> data) {
        switch(eventName){
          case HelpshiftEvent.RECEIVED_UNREAD_MESSAGE_COUNT:
            int count = (int) data.get(HelpshiftEvent.DATA_MESSAGE_COUNT);
            boolean fromCache = (boolean) data.get(HelpshiftEvent.DATA_MESSAGE_COUNT_FROM_CACHE);
            if (fromCache) {
              Log.d("Notification Count", "local" + count);
            } else {
              Log.d("Notification Count", "server" + count);
            }
        }
      }
    // ...
```

- 通知の数は、SDK のキャッシュと Helpshift のサーバーからこの API を介して取得されます（上記の例では`fromCache`の値で示されています）。しかしながら、Helpshift サーバーから取得する場合の通知数についてはレートが制限されており、タイムアウトのリセット後またはユーザーがチャット画面を閉じた後（いずれかの早い方）に API に対する次の呼び出しが行われた場合にのみ値が返されます。タイムアウトのリセット時間は、アクティブな問題の場合は 1 分、そして非アクティブな問題の場合には 5 分に設定されています。
